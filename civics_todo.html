<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Civics Committee To-Do List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="userIdDisplay">Loading User ID...</div>
  <div id="loadingSpinner">Loading...</div>
  <div id="messageBox" style="display:none;"><span id="messageText"></span></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtbhLpGkAd7HYd1iXh17Nb_JwDVnY1ozc",
      authDomain: "civics-dash.firebaseapp.com",
      projectId: "civics-dash",
      storageBucket: "civics-dash.appspot.com",
      messagingSenderId: "953440156893",
      appId: "1:953440156893:web:08865d0d5b71d23e3bef34",
      measurementId: "G-VVY8VGDQY9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const displayMessage = (message, type = 'info') => {
      const messageBox = document.getElementById('messageBox');
      const messageText = document.getElementById('messageText');
      messageText.textContent = message;
      messageBox.style.display = 'block';
      messageBox.style.backgroundColor = type === 'error' ? '#fecaca' : '#d1fae5';
      setTimeout(() => messageBox.style.display = 'none', 5000);
    };

    const signIn = async () => {
      try {
        const token = window.__initial_auth_token || null;
        if (token) {
          console.log("Attempting custom token sign-in");
          await signInWithCustomToken(auth, token);
        } else {
          console.log("Attempting anonymous sign-in");
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Authentication failed:", error);
        displayMessage(`Auth error (${error.code}): ${error.message}`, 'error');
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('userIdDisplay').textContent = `User ID: ${user.uid}`;
        document.getElementById('loadingSpinner').style.display = 'none';
        displayMessage('Authentication successful!', 'success');

        // Test Firestore read to confirm access
        try {
          const testRef = doc(db, 'test/authCheck');
          const testSnap = await getDoc(testRef);
          if (testSnap.exists()) {
            console.log("Firestore test read successful:", testSnap.data());
          } else {
            await setDoc(testRef, { status: 'created for test' });
            console.log("Created test document in Firestore.");
          }
        } catch (err) {
          console.error("Firestore access error:", err);
          displayMessage(`Firestore error (${err.code}): ${err.message}`, 'error');
        }

      } else {
        await signIn();
      }
    });
  </script>
</body>
</html>

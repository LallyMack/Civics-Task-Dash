<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civics Committee To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBtbhLpGkAd7HYd1iXhl7Nb_JwDVnY1ozc",
            authDomain: "civics-dash.firebaseapp.com",
            projectId: "civics-dash",
            storageBucket: "civics-dash.firebasestorage.app",
            messagingSenderId: "953440156893",
            appId: "1:953440156893:web:08865d0d5b71d23e3bef34",
            measurementId: "G-VVY8VGDQY9"
        };
        window.firebaseConfig = firebaseConfig; // Set the global variable

        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // This will remain 'default-app-id' if not in Canvas

        // Initialize Firebase and Firestore (Ensured only once)
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        window.tasksCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/civics_tasks`);

        window.userId = null;
        window.isAuthReady = false;

        // Authenticate and set up auth state listener
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `User ID: ${window.userId}`;
                window.isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", window.userId);
                setupRealtimeTasksListener();
            } else {
                try {
                    if (window.initialAuthToken) {
                        await signInWithCustomToken(window.auth, window.initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    showMessage('Authentication failed. Some features may not work.', 'error');
                    window.isAuthReady = true;
                    document.getElementById('loadingSpinner').classList.add('hidden');
                }
            }
        });

        // Expose Firebase functions globally for use in the main script block
        window.firebase = {
            addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy
        };
    </script>
    <!-- Visualization & Content Choices:
        - Task List (HTML/Tailwind cards): Goal: Organize/Inform/Manage. Interaction: Display task details, allow status change via dropdown, allow member assignment via dropdown, allow editing via button (transforms card to form), allow removal via button. Includes dynamically calculated 'Days Remaining'. Justification: Clear presentation of individual tasks, direct management of status, assignment, editing, and deletion, and quick view of deadlines.
        - Category Filters (HTML buttons): Goal: Filter. Interaction: Click to show tasks of selected category. Justification: Easy focus on specific work areas.
        - Priority Filters (HTML buttons): Goal: Filter. Interaction: Click to show tasks of selected priority. Justification: Focus on urgency.
        - Status Filters (HTML buttons): Goal: Filter. Interaction: Click to show tasks of selected status. Justification: Track progress stages.
        - Assignee Filters (HTML buttons): Goal: Filter. Interaction: Click to show tasks assigned to a specific member. Justification: Focus on individual workloads.
        - "Add Task" Form (HTML form + JS): Goal: Manage/Create. Interaction: Input fields, dropdowns, submit button to add new task. Includes due date input. Justification: Direct task creation within the app with deadline tracking.
        - Status Distribution Chart (Chart.js Donut): Goal: Inform/Track Progress. Data: Count of tasks by status. Interaction: Tooltips. Justification: Quick visual summary of overall progress. Library: Chart.js.
        - Tasks per Category Chart (Chart.js Bar): Goal: Inform/Compare. Data: Count of tasks by category. Interaction: Tooltips. Justification: Visual comparison of workload across categories. Library: Chart.js.
        - Introductory Text (HTML paragraphs): Goal: Inform/Contextualize. Justification: Explain SPA purpose and section functionalities.
        CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            /* Light Mode Colors */
            --bg-primary: #f8fafc; /* slate-50 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #1e293b; /* slate-900 */
            --text-secondary: #475569; /* slate-600 */
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-dark: #0284c7; /* sky-700 */
            --border-color: #e2e8f0; /* slate-200 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --filter-button-bg: #e2e8f0; /* slate-200 */
            --filter-button-text: #475569; /* slate-600 */
            --filter-button-hover-bg: #cbd5e1; /* slate-300 */
            --input-border: #cbd5e1; /* slate-300 */
            --status-todo-bg: #cbd5e1; /* slate-300 */
            --status-todo-text: #475569; /* slate-600 */
            --status-inprogress-bg: #93c5fd; /* blue-300 */
            --status-inprogress-text: #1d4ed8; /* blue-700 */
            --status-done-bg: #86efac; /* green-300 */
            --status-done-text: #16a34a; /* green-700 */
            --status-blocked-bg: #fca5a5; /* red-300 */
            --status-blocked-text: #b91c1c; /* red-700 */
            --priority-high-border: #ef4444; /* red-500 */
            --priority-medium-border: #f59e0b; /* amber-500 */
            --priority-ongoing-border: #a855f7; /* purple-500 */
        }

        .dark {
            /* Dark Mode Colors */
            --bg-primary: #1e293b; /* slate-900 */
            --bg-secondary: #334155; /* slate-700 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #cbd5e1; /* slate-300 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-dark: #0ea5e9; /* sky-500 */
            --border-color: #475569; /* slate-600 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --filter-button-bg: #475569; /* slate-600 */
            --filter-button-text: #cbd5e1; /* slate-300 */
            --filter-button-hover-bg: #64748b; /* slate-500 */
            --input-border: #64748b; /* slate-500 */
            --status-todo-bg: #475569; /* slate-600 */
            --status-todo-text: #cbd5e1; /* slate-300 */
            --status-inprogress-bg: #1d4ed8; /* blue-700 */
            --status-inprogress-text: #93c5fd; /* blue-300 */
            --status-done-bg: #16a34a; /* green-700 */
            --status-done-text: #86efac; /* green-300 */
            --status-blocked-bg: #b91c1c; /* red-700 */
            --status-blocked-text: #fca5a5; /* red-300 */
            --priority-high-border: #ef4444; /* red-500 */
            --priority-medium-border: #f59e0b; /* amber-500 */
            --priority-ongoing-border: #a855f7; /* purple-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .filter-button {
            background-color: var(--filter-button-bg);
            color: var(--filter-button-text);
            transition: all 0.2s ease-in-out;
        }
        .filter-button:hover {
            background-color: var(--filter-button-hover-bg);
        }
        .filter-button.active {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Chart container styling to control size and responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin-left: auto;
            margin-right: auto;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--bg-secondary);
            box-shadow: var(--card-shadow);
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        @media (min-width: 1024px) {
             .chart-container {
                height: 300px;
            }
        }

        /* Custom scrollbar for task list if it overflows */
        #taskListContainer::-webkit-scrollbar {
            width: 8px;
        }
        #taskListContainer::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 10px;
        }
        #taskListContainer::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        #taskListContainer::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        .task-card {
            background-color: var(--bg-secondary);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
         /* Styling for select dropdowns */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em;
            background-color: var(--bg-primary); /* Ensure dropdown background matches theme */
            color: var(--text-primary);
            border-color: var(--input-border);
        }
        input[type="text"], input[type="date"], textarea {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--input-border);
        }
        .spinner {
            border: 4px solid rgba(100, 116, 139, 0.4); /* slate-400 with alpha */
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message-box {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--card-shadow);
        }
        .message-box.success {
            background-color: var(--status-done-bg);
            color: var(--status-done-text);
        }
        .message-box.error {
            background-color: var(--status-blocked-bg);
            color: var(--status-blocked-text);
        }
        .text-sky-700 { color: var(--accent-dark); }
        .text-sky-600 { color: var(--accent-color); }
        .bg-sky-600 { background-color: var(--accent-color); }
        .hover\:bg-sky-700:hover { background-color: var(--accent-dark); }
        .focus\:ring-sky-500:focus { --tw-ring-color: var(--accent-color); }
        .focus\:border-sky-500:focus { border-color: var(--accent-color); }
        .text-stone-700 { color: var(--text-primary); }
        .text-stone-600 { color: var(--text-secondary); }
        .text-stone-500 { color: var(--text-secondary); }
        .bg-white { background-color: var(--bg-secondary); }
        .border-stone-300 { border-color: var(--input-border); }
        .shadow { box-shadow: var(--card-shadow); }
        .hover\:shadow-md:hover { box-shadow: var(--card-shadow); } /* Keep consistent shadow */

        /* Specific status colors for select backgrounds */
        .status-select.bg-slate-100 { background-color: var(--status-todo-bg); color: var(--status-todo-text); }
        .status-select.bg-blue-100 { background-color: var(--status-inprogress-bg); color: var(--status-inprogress-text); }
        .status-select.bg-green-100 { background-color: var(--status-done-bg); color: var(--status-done-text); }
        .status-select.bg-red-100 { background-color: var(--status-blocked-bg); color: var(--status-blocked-text); }

        /* Priority border colors */
        .border-red-500 { border-color: var(--priority-high-border); }
        .border-yellow-500 { border-color: var(--priority-medium-border); }
        .border-purple-500 { border-color: var(--priority-ongoing-border); }
        .text-red-600 { color: var(--priority-high-border); }
        .text-yellow-600 { color: var(--priority-medium-border); }
        .text-purple-600 { color: var(--priority-ongoing-border); }
        .text-stone-600 { color: var(--text-secondary); } /* Default for other text */
        .text-stone-700 { color: var(--text-primary); } /* Default for other text */
        .text-stone-500 { color: var(--text-secondary); } /* Default for other text */

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-stone-100 text-stone-800 antialiased">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-2xl md:text-3xl font-bold text-sky-700">üìã</span>
                    <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Civics Committee To-Do</h1>
                </div>
                <button id="themeToggle" class="p-2 rounded-full bg-stone-200 dark:bg-stone-700 text-stone-700 dark:text-stone-200 shadow-md hover:scale-105 transition-transform duration-200">
                    <span id="themeIcon" class="text-xl">üåô</span>
                </button>
            </div>
            <p class="mt-2 text-stone-600">This tool helps track progress, tasks and priorities for Civics Committee 2025.</p>
            <div class="mt-4 text-sm text-stone-500 flex items-center justify-center gap-2">
                <span id="userIdDisplay">Loading User ID...</span>
                <div id="loadingSpinner" class="spinner hidden"></div>
            </div>
        </header>

        <section id="filters" class="mb-6 p-4 bg-white rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-3 text-sky-600">Filter Tasks</h2>
            <p class="text-sm text-stone-600 mb-3">Use the filters below to narrow down the tasks displayed in the list and reflected in the charts. Click a filter again to deactivate it or select "All".</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                <div>
                    <h3 class="font-medium mb-2 text-stone-700">By Category:</h3>
                    <div id="categoryFilters" class="flex flex-wrap gap-1"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2 text-stone-700">By Priority:</h3>
                    <div id="priorityFilters" class="flex flex-wrap gap-1"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2 text-stone-700">By Status:</h3>
                    <div id="statusFilters" class="flex flex-wrap gap-1"></div>
                </div>
                <div>
                    <h3 class="font-medium mb-2 text-stone-700">By Assignee:</h3>
                    <div id="assigneeFilters" class="flex flex-wrap gap-1"></div>
                </div>
            </div>
        </section>

        <section id="addTask" class="mb-8 p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-sky-600">Add New Task</h2>
            <p class="text-sm text-stone-600 mb-4">Fill in the details below to add a new task to the list.</p>
            <form id="addTaskForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label for="taskName" class="block text-sm font-medium text-stone-700">Task Name:</label>
                    <input type="text" id="taskName" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="taskCategory" class="block text-sm font-medium text-stone-700">Category:</label>
                    <select id="taskCategory" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2" required>
                        </select>
                </div>
                <div>
                    <label for="taskPriority" class="block text-sm font-medium text-stone-700">Priority:</label>
                    <select id="taskPriority" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2" required>
                        </select>
                </div>
                <div>
                    <label for="taskStatus" class="block text-sm font-medium text-stone-700">Status:</label>
                    <select id="taskStatus" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2" required>
                        </select>
                </div>
                <div>
                    <label for="taskAssignee" class="block text-sm font-medium text-stone-700">Assignee:</label>
                    <select id="taskAssignee" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2">
                        </select>
                </div>
                 <div>
                    <label for="taskDueDate" class="block text-sm font-medium text-stone-700">Due Date (Optional):</label>
                    <input type="date" id="taskDueDate" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2">
                </div>
                <div class="md:col-span-2">
                    <label for="taskNotes" class="block text-sm font-medium text-stone-700">Notes (Optional):</label>
                    <textarea id="taskNotes" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm sm:text-sm p-2"></textarea>
                </div>
                <div class="md:col-span-2 text-right">
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors duration-200">
                        Add Task
                    </button>
                </div>
            </form>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section class="lg:col-span-2 p-6 bg-white rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-sky-600">Task List</h2>
                <p class="text-sm text-stone-600 mb-4">Below is the list of tasks. You can change the status and assignee of each task using the dropdowns. Click 'Edit' to modify a task's details or 'Remove' to delete it.</p>
                <div id="taskListContainer" class="space-y-4 max-h-[600px] lg:max-h-[calc(100vh-400px)] overflow-y-auto pr-2">
                    <div id="initialLoading" class="text-center py-8">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-stone-600">Loading tasks...</p>
                    </div>
                </div>
                <p id="noTasksMessage" class="hidden text-center text-stone-600 py-8">No tasks match the current filters.</p>
            </section>

            <aside class="lg:col-span-1 space-y-8">
                <section>
                    <h2 class="text-xl font-semibold mb-4 text-sky-600 text-center">Task Status Overview</h2>
                    <p class="text-sm text-stone-600 mb-4 text-center">This chart shows the distribution of tasks by their current status.</p>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </section>
                <section>
                    <h2 class="text-xl font-semibold mb-4 text-sky-600 text-center">Tasks per Category</h2>
                    <p class="text-sm text-stone-600 mb-4 text-center">This chart displays the number of tasks within each category.</p>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </section>
            </aside>
        </main>

        <footer class="mt-12 text-center text-sm text-stone-600">
            <p>&copy; 2025 Civics Committee Task Manager. For illustrative and planning purposes.</p>
        </footer>
    </div>

    <div id="messageBox" class="message-box">
        <span id="messageText"></span>
    </div>

    <script>
        // Initial members list (Moved to global scope and ensured single declaration)
        const members = [
            "Unassigned", "Reshan Fernando", "Taichi Yokoyama", "Takeshi Ohishi",
            "Michael Madoff", "Larisa Mcfarlane", "Nicolas Cerny", "Ken Erik √òlmheim",
            "Nana Safo", "Randy", "Joseph Mermoz Dzubang", "Aleksei Seregin",
            "Lorenzo Bruno", "Thomas Lindseth"
        ];

        // Initial tasks data (will be overridden by Firestore)
        let tasksData = [];

        const allCategories = ["All", "Immediate Priorities", "Housekeeping & Setup", "Work Priorities", "Ongoing Participation"];
        const allPriorities = ["All", "High", "Medium", "Ongoing"];
        const allStatuses = ["All", "To Do", "In Progress", "Done", "Blocked"];
        const allAssignees = ["All", ...members];

        let currentFilters = {
            category: "All",
            priority: "All",
            status: "All",
            assignee: "All"
        };

        let statusChartInstance, categoryChartInstance;
        
        // Colors for charts and status indicators, using CSS variables for theme compatibility
        const statusColors = {
            'To Do': 'var(--status-todo-bg)',
            'In Progress': 'var(--status-inprogress-bg)',
            'Done': 'var(--status-done-bg)',
            'Blocked': 'var(--status-blocked-bg)'
        };

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            messageBox.className = `message-box show ${type}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        function calculateDaysRemaining(dueDate) {
            if (!dueDate) return 'No due date';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);

            const diffTime = due.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Due Today';
            if (diffDays === 1) return 'Due Tomorrow';
            if (diffDays < 0) return `${Math.abs(diffDays)} day(s) overdue`;
            return `${diffDays} day(s) remaining`;
        }

        function renderTasks() {
            const taskListContainer = document.getElementById('taskListContainer');
            const noTasksMessage = document.getElementById('noTasksMessage');
            const initialLoading = document.getElementById('initialLoading');

            if (!window.isAuthReady) {
                initialLoading.classList.remove('hidden');
                return;
            } else {
                initialLoading.classList.add('hidden');
            }

            taskListContainer.innerHTML = '';

            const filteredTasks = tasksData.filter(task => {
                return (currentFilters.category === "All" || task.category === currentFilters.category) &&
                       (currentFilters.priority === "All" || task.priority === currentFilters.priority) &&
                       (currentFilters.status === "All" || task.status === currentFilters.status) &&
                       (currentFilters.assignee === "All" || task.assignedTo === currentFilters.assignee);
            });

            if (filteredTasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                filteredTasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = `task-card p-4 rounded-lg border-l-4 ${getPriorityClass(task.priority)}`;
                    
                    if (task.isEditing) {
                        let categoryOptions = allCategories.slice(1).map(c => `<option value="${c}" ${task.category === c ? 'selected' : ''}>${c}</option>`).join('');
                        let priorityOptions = allPriorities.slice(1).map(p => `<option value="${p}" ${task.priority === p ? 'selected' : ''}>${p}</option>`).join('');
                        let statusOptions = allStatuses.slice(1).map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('');
                        let assigneeOptions = members.map(m => `<option value="${m}" ${task.assignedTo === m ? 'selected' : ''}>${m}</option>`).join('');

                        card.innerHTML = `
                            <div class="flex flex-col gap-2">
                                <label for="editTaskName-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Task Name:</label>
                                <input type="text" id="editTaskName-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2" value="${task.name}" required>
                                
                                <label for="editTaskCategory-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Category:</label>
                                <select id="editTaskCategory-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2" required>
                                    ${categoryOptions}
                                </select>
                                
                                <label for="editTaskPriority-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Priority:</label>
                                <select id="editTaskPriority-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2" required>
                                    ${priorityOptions}
                                </select>
                                
                                <label for="editTaskStatus-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Status:</label>
                                <select id="editTaskStatus-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2" required>
                                    ${statusOptions}
                                </select>
                                
                                <label for="editTaskAssignee-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Assignee:</label>
                                <select id="editTaskAssignee-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2">
                                    ${assigneeOptions}
                                </select>

                                <label for="editTaskDueDate-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Due Date (Optional):</label>
                                <input type="date" id="editTaskDueDate-${task.id}" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2" value="${task.dueDate || ''}">

                                <label for="editTaskNotes-${task.id}" class="block text-sm font-medium text-[var(--text-primary)]">Notes (Optional):</label>
                                <textarea id="editTaskNotes-${task.id}" rows="2" class="mt-1 block w-full rounded-md border-[var(--input-border)] shadow-sm sm:text-sm p-2">${task.notes}</textarea>

                                <div class="flex justify-end gap-2 mt-4">
                                    <button data-task-id="${task.id}" class="save-task-btn inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-[var(--accent-color)] hover:bg-[var(--accent-dark)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-color)] transition-colors duration-200">
                                        Save Changes
                                    </button>
                                    <button data-task-id="${task.id}" class="cancel-edit-btn inline-flex justify-center py-2 px-4 border border-[var(--input-border)] shadow-sm text-sm font-medium rounded-md text-[var(--text-primary)] bg-[var(--bg-secondary)] hover:bg-[var(--filter-button-hover-bg)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--input-border)] transition-colors duration-200">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        let statusSelectOptions = allStatuses.slice(1).map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('');
                        let assigneeSelectOptions = members.map(m => `<option value="${m}" ${task.assignedTo === m ? 'selected' : ''}>${m}</option>`).join('');
                        
                        const daysRemainingText = calculateDaysRemaining(task.dueDate);
                        const daysRemainingClass = daysRemainingText.includes('overdue') ? 'text-red-500 font-semibold' : 'text-stone-600';

                        card.innerHTML = `
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2">
                                <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-2 sm:mb-0">${task.name}</h3>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <select data-task-id="${task.id}" class="status-select text-sm border border-[var(--input-border)] rounded-md p-1 ${getStatusColorClass(task.status)}">
                                        ${statusSelectOptions}
                                    </select>
                                    <select data-task-id="${task.id}" class="assignee-select text-sm border border-[var(--input-border)] rounded-md p-1">
                                        ${assigneeOptions}
                                    </select>
                                    <button data-task-id="${task.id}" class="edit-task-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-sm transition-colors duration-200">
                                        Edit
                                    </button>
                                    <button data-task-id="${task.id}" class="remove-task-btn bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-1 px-3 rounded-md shadow-sm transition-colors duration-200">
                                        Remove
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-[var(--accent-color)] font-medium mt-1 mb-1">Category: ${task.category} | Priority: <span class="${getPriorityTextClass(task.priority)}">${task.priority}</span></p>
                            <p class="text-xs ${daysRemainingClass} mb-2">Assigned To: <span class="font-medium text-[var(--text-primary)]">${task.assignedTo}</span></p>
                            <p class="text-xs ${daysRemainingClass} mb-2">Due Date: <span class="font-medium">${daysRemainingText}</span></p>
                            ${task.notes ? `<p class="text-sm text-[var(--text-secondary)] mt-1">${task.notes}</p>` : ''}
                        `;
                    }
                    taskListContainer.appendChild(card);
                });
            }
            addStatusChangeListeners();
            addAssigneeChangeListeners();
            addRemoveTaskListeners();
            addEditTaskListeners();
            addSaveCancelEditListeners();
            updateCharts();
        }
        
        function getPriorityClass(priority) {
            if (priority === "High") return 'border-[var(--priority-high-border)]';
            if (priority === "Medium") return 'border-[var(--priority-medium-border)]';
            if (priority === "Ongoing") return 'border-[var(--priority-ongoing-border)]';
            return 'border-[var(--border-color)]';
        }

        function getPriorityTextClass(priority) {
            if (priority === "High") return 'text-[var(--priority-high-border)] font-semibold';
            if (priority === "Medium") return 'text-[var(--priority-medium-border)] font-semibold';
            if (priority === "Ongoing") return 'text-[var(--priority-ongoing-border)] font-semibold';
            return 'text-[var(--text-secondary)]';
        }
        
        function getStatusColorClass(status) {
            if (status === "To Do") return 'bg-[var(--status-todo-bg)] text-[var(--status-todo-text)]';
            if (status === "In Progress") return 'bg-[var(--status-inprogress-bg)] text-[var(--status-inprogress-text)]';
            if (status === "Done") return 'bg-[var(--status-done-bg)] text-[var(--status-done-text)]';
            if (status === "Blocked") return 'bg-[var(--status-blocked-bg)] text-[var(--status-blocked-text)]';
            return 'bg-gray-100'; // Fallback
        }

        async function updateTaskInFirestore(taskId, updates) {
            if (!window.isAuthReady) {
                showMessage('Authentication not ready. Please try again.', 'error');
                return;
            }
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.tasksCollectionRef, taskId), updates);
                showMessage('Task updated successfully!', 'success');
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage('Error updating task.', 'error');
            }
        }

        function addStatusChangeListeners() {
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', async (event) => {
                    const taskId = event.target.dataset.taskId;
                    const newStatus = event.target.value;
                    const task = tasksData.find(t => t.id === taskId); // Find by Firestore ID
                    if (task) {
                        task.status = newStatus; // Optimistic UI update
                        event.target.className = `status-select text-sm border border-[var(--input-border)] rounded-md p-1 ${getStatusColorClass(newStatus)}`;
                        await updateTaskInFirestore(taskId, { status: newStatus });
                    }
                });
            });
        }

        function addAssigneeChangeListeners() {
            document.querySelectorAll('.assignee-select').forEach(select => {
                select.addEventListener('change', async (event) => {
                    const taskId = event.target.dataset.taskId;
                    const newAssignee = event.target.value;
                    const task = tasksData.find(t => t.id === taskId); // Find by Firestore ID
                    if (task) {
                        task.assignedTo = newAssignee; // Optimistic UI update
                        await updateTaskInFirestore(taskId, { assignedTo: newAssignee });
                    }
                });
            });
        }

        function addRemoveTaskListeners() {
            document.querySelectorAll('.remove-task-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const taskId = event.target.dataset.taskId;
                    if (!window.isAuthReady) {
                        showMessage('Authentication not ready. Please try again.', 'error');
                        return;
                    }
                    try {
                        await window.firebase.deleteDoc(window.firebase.doc(window.tasksCollectionRef, taskId));
                        showMessage('Task removed successfully!', 'success');
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showMessage('Error removing task.', 'error');
                    }
                });
            });
        }

        function addEditTaskListeners() {
            document.querySelectorAll('.edit-task-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const taskId = event.target.dataset.taskId; // Use Firestore ID
                    const task = tasksData.find(t => t.id === taskId);
                    if (task) {
                        task.isEditing = true;
                        renderTasks();
                    }
                });
            });
        }

        function addSaveCancelEditListeners() {
            document.querySelectorAll('.save-task-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const taskId = event.target.dataset.taskId; // Use Firestore ID
                    const task = tasksData.find(t => t.id === taskId);
                    if (task) {
                        const updatedTask = {
                            name: document.getElementById(`editTaskName-${task.id}`).value,
                            category: document.getElementById(`editTaskCategory-${task.id}`).value,
                            priority: document.getElementById(`editTaskPriority-${task.id}`).value,
                            status: document.getElementById(`editTaskStatus-${task.id}`).value,
                            assignedTo: document.getElementById(`editTaskAssignee-${task.id}`).value,
                            dueDate: document.getElementById(`editTaskDueDate-${task.id}`).value || null,
                            notes: document.getElementById(`editTaskNotes-${task.id}`).value,
                        };
                        task.isEditing = false; // Optimistic UI update
                        Object.assign(task, updatedTask); // Update local task object
                        await updateTaskInFirestore(taskId, updatedTask);
                    }
                });
            });

            document.querySelectorAll('.cancel-edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const taskId = event.target.dataset.taskId; // Use Firestore ID
                    const task = tasksData.find(t => t.id === taskId);
                    if (task) {
                        task.isEditing = false;
                        renderTasks();
                    }
                });
            });
        }

        function createFilterButtons(containerId, items, filterType, activeColor = 'bg-[var(--accent-color)] text-white', defaultColor = 'bg-[var(--filter-button-bg)] text-[var(--filter-button-text)] hover:bg-[var(--filter-button-hover-bg)]') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const button = document.createElement('button');
                button.textContent = item;
                if (item.length > 15 && item !== "Unassigned") {
                    button.textContent = item.substring(0, 12) + '...';
                }
                button.className = `filter-button py-2 px-4 rounded-md text-sm font-medium shadow-sm ${currentFilters[filterType] === item ? activeColor : defaultColor}`;
                button.onclick = () => {
                    currentFilters[filterType] = item;
                    document.querySelectorAll(`#${containerId} .filter-button`).forEach(btn => {
                        btn.className = `filter-button py-2 px-4 rounded-md text-sm font-medium shadow-sm ${currentFilters[filterType] === btn.dataset.originalValue ? activeColor : defaultColor}`;
                        if (currentFilters[filterType] === btn.dataset.originalValue) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    renderTasks();
                };
                button.dataset.originalValue = item;
                if (currentFilters[filterType] === item) button.classList.add('active');
                container.appendChild(button);
            });
        }
        
        function truncateLabel(label, maxLength = 20) {
            if (label.length > maxLength) {
                return label.substring(0, maxLength - 3) + '...';
            }
            return label;
        }

        function updateCharts() {
            const chartFilteredTasks = tasksData.filter(task => {
                return (currentFilters.category === "All" || task.category === currentFilters.category) &&
                       (currentFilters.priority === "All" || task.priority === currentFilters.priority) &&
                       (currentFilters.assignee === "All" || task.assignedTo === currentFilters.assignee);
            });

            const statusCounts = allStatuses.slice(1).reduce((acc, status) => {
                acc[status] = chartFilteredTasks.filter(task => task.status === status).length;
                return acc;
            }, {});

            if (statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Tasks by Status',
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(status => getComputedStyle(document.documentElement).getPropertyValue(statusColors[status])),
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bg-secondary'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            const categoryTaskCounts = allCategories.slice(1).reduce((acc, category) => {
                acc[category] = tasksData.filter(task =>
                    task.category === category &&
                    (currentFilters.priority === "All" || task.priority === currentFilters.priority) &&
                    (currentFilters.status === "All" || task.status === currentFilters.status) &&
                    (currentFilters.assignee === "All" || task.assignedTo === currentFilters.assignee)
                ).length;
                return acc;
            }, {});

            if (categoryChartInstance) categoryChartInstance.destroy();
            categoryChartInstance = new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryTaskCounts).map(label => truncateLabel(label)),
                    datasets: [{
                        label: 'Number of Tasks',
                        data: Object.values(categoryTaskCounts),
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color') + 'B3', // 70% opacity
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-dark'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grace: '5%',
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') + '40' } // Lighter grid lines
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') + '40' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                         tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const originalIndex = tooltipItems[0].dataIndex;
                                    return Object.keys(categoryTaskCounts)[originalIndex];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Theme Toggle Logic
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è'; // Sun icon for dark mode
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').textContent = 'üåô'; // Moon icon for light mode
            }
        }

        // Setup Firestore real-time listener (moved to global scope)
        function setupRealtimeTasksListener() {
            if (!window.isAuthReady) {
                console.warn("Firestore listener not set up: Authentication not ready.");
                return;
            }
            const q = window.firebase.query(window.tasksCollectionRef); // You can add orderBy here if needed
            window.firebase.onSnapshot(q, (snapshot) => {
                const newTasks = [];
                snapshot.forEach((doc) => {
                    newTasks.push({ id: doc.id, ...doc.data() });
                });
                tasksData = newTasks;
                renderTasks(); // Re-render tasks and charts when data changes
                document.getElementById('loadingSpinner').classList.add('hidden');
            }, (error) => {
                console.error("Error getting real-time tasks: ", error);
                showMessage('Error loading tasks. Please refresh.', 'error');
                document.getElementById('loadingSpinner').classList.add('hidden');
            });
        }


        document.getElementById('themeToggle').addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').textContent = 'üåô';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
            updateCharts();
        });

        // Initial Render and Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('loadingSpinner').classList.remove('hidden');

            createFilterButtons('categoryFilters', allCategories, 'category');
            createFilterButtons('priorityFilters', allPriorities, 'priority');
            createFilterButtons('statusFilters', allStatuses, 'status');
            createFilterButtons('assigneeFilters', allAssignees, 'assignee');
            
            // Populate "Add Task" form dropdowns
            const taskCategorySelect = document.getElementById('taskCategory');
            allCategories.slice(1).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                taskCategorySelect.appendChild(option);
            });

            const taskPrioritySelect = document.getElementById('taskPriority');
            allPriorities.slice(1).forEach(prio => {
                const option = document.createElement('option');
                option.value = prio;
                option.textContent = prio;
                taskPrioritySelect.appendChild(option);
            });

            const taskStatusSelect = document.getElementById('taskStatus');
            allStatuses.slice(1).forEach(stat => {
                const option = document.createElement('option');
                option.value = stat;
                option.textContent = stat;
                taskStatusSelect.appendChild(option);
            });
            taskStatusSelect.value = "To Do";

            const taskAssigneeSelect = document.getElementById('taskAssignee');
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                taskAssigneeSelect.appendChild(option);
            });
            taskAssigneeSelect.value = "Unassigned";

            // Add Task Form Submission
            document.getElementById('addTaskForm').addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!window.isAuthReady) {
                    showMessage('Authentication not ready. Please try again.', 'error');
                    return;
                }

                const newTask = {
                    name: document.getElementById('taskName').value,
                    category: document.getElementById('taskCategory').value,
                    priority: document.getElementById('taskPriority').value,
                    status: document.getElementById('taskStatus').value,
                    notes: document.getElementById('taskNotes').value,
                    assignedTo: document.getElementById('taskAssignee').value,
                    dueDate: document.getElementById('taskDueDate').value || null,
                    isEditing: false
                };

                try {
                    await window.firebase.addDoc(window.tasksCollectionRef, newTask);
                    showMessage('Task added successfully!', 'success');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage('Error adding task.', 'error');
                }

                document.getElementById('addTaskForm').reset();
                taskStatusSelect.value = "To Do";
                taskAssigneeSelect.value = "Unassigned";
            });
        });
    </script>
</body>
</html>
